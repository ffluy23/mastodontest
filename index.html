mkdir mastodon-bot
cd mastodon-bot
npm init -y
npm install mastodon-api dotenv
MASTODON_ACCESS_TOKEN=BMjexVZXj4IlW4g8vpFx-88Y8Mq1r8Wx6VlQcp2lAeY
MASTODON_API_URL=https://@mastodon.social
require('dotenv').config();
const Mastodon = require('mastodon-api');
const fs = require('fs');

// ==============================
// ì„¤ì •
// ==============================
const M = new Mastodon({
  access_token: process.env.MASTODON_ACCESS_TOKEN,
  timeout_ms: 60 * 1000,
  api_url: process.env.MASTODON_API_URL + '/api/v1/'
});

// ì¶œì„ ë°ì´í„° íŒŒì¼
const ATTENDANCE_FILE = './attendance.json';

// ==============================
// ì¶œì„ ë°ì´í„° ë¡œë“œ/ì €ì¥
// ==============================
function loadAttendance() {
  if (!fs.existsSync(ATTENDANCE_FILE)) {
    return {};
  }
  return JSON.parse(fs.readFileSync(ATTENDANCE_FILE));
}

function saveAttendance(data) {
  fs.writeFileSync(ATTENDANCE_FILE, JSON.stringify(data, null, 2));
}

// ==============================
// ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´
// ==============================
function getToday() {
  const today = new Date();
  return today.toISOString().split('T')[0]; // YYYY-MM-DD
}

// ==============================
// ë©˜ì…˜ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
// ==============================
console.log("ğŸ¤– ë´‡ ì‹¤í–‰ ì¤‘...");

const stream = M.stream('streaming/user');

stream.on('message', async (msg) => {
  if (msg.event !== 'notification') return;

  const notification = msg.data;

  if (notification.type !== 'mention') return;

  const status = notification.status;
  const content = status.content.replace(/<[^>]*>?/gm, ''); // HTML ì œê±°
  const user = status.account;

  console.log(`ë©˜ì…˜ ë°›ìŒ: ${content}`);

  // ==========================
  // "ì•ˆë…•" í‚¤ì›Œë“œ
  // ==========================
  if (content.includes("ì•ˆë…•")) {
    await reply(status, `@${user.acct} ì•ˆë…•! ğŸ‘‹ ë§Œë‚˜ì„œ ë°˜ê°€ì›Œ!`);
    return;
  }

  // ==========================
  // "ì¶œì„" í‚¤ì›Œë“œ
  // ==========================
  if (content.includes("ì¶œì„")) {
    const attendanceData = loadAttendance();
    const today = getToday();
    const userId = user.id;

    if (!attendanceData[userId]) {
      attendanceData[userId] = {};
    }

    if (attendanceData[userId][today]) {
      await reply(status, `@${user.acct} ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í–ˆì–´! ğŸ˜†`);
    } else {
      attendanceData[userId][today] = true;
      saveAttendance(attendanceData);
      await reply(status, `@${user.acct} âœ… ì˜¤ëŠ˜ ì¶œì„ ì™„ë£Œ!`);
    }
  }
});

// ==============================
// ë‹µê¸€ í•¨ìˆ˜
// ==============================
async function reply(status, text) {
  try {
    await M.post('statuses', {
      status: text,
      in_reply_to_id: status.id,
      visibility: status.visibility
    });
  } catch (err) {
    console.error("ì—ëŸ¬:", err);
  }
}

// ==============================
// ì—ëŸ¬ ì²˜ë¦¬
// ==============================
stream.on('error', (err) => {
  console.error("ìŠ¤íŠ¸ë¦¼ ì—ëŸ¬:", err);
});
